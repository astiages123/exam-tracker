# ğŸ” Quiz & Soru BankasÄ± Sistemi - KapsamlÄ± Denetim Raporu

> **Tarih:** 6 Ocak 2026  
> **Kapsam:** VeritabanÄ±, SRS Motoru, Soru FabrikasÄ±, Zengin Ä°Ã§erik, Ä°statistikler

---

## ğŸ“Š Mevcut Sistem Mimarisi

```mermaid
graph TB
    subgraph "Frontend (React)"
        QM[QuizModal.jsx]
        QC[QuizChart.jsx]
        QE[QuizExplanation.jsx]
        LR[LatexRenderer]
    end
    
    subgraph "Servisler (TypeScript)"
        QS[quizService.ts]
        SS[stockpileService.ts]
        SE[srsEngine.ts]
        RL[rateLimiter.ts]
    end
    
    subgraph "AI Modelleri (Groq)"
        W[Llama-3.1-8b<br/>Worker/Ãœretici]
        V[Llama-3.3-70b<br/>Validator/DenetÃ§i]
    end
    
    subgraph "Supabase"
        QB[(question_bank)]
        LC[(lesson_chunks)]
        UAQ[(user_answered_questions)]
        US[(user_statistics)]
        EB[(error_book)]
    end
    
    QM --> QS
    QS --> SE
    QS --> QB
    SS --> W --> V
    SS --> QB
    QS --> UAQ
    SE --> UAQ
```

---

## 1. ğŸ“ˆ VERÄ°MLÄ°LÄ°K ANALÄ°ZÄ°

### Mevcut Durum

| Tablo | Tahmini Boyut | Mevcut Ä°ndeksler |
|-------|---------------|------------------|
| `question_bank` | 7.000+ soru hedefi | `chunk_id` Ã¼zerinde |
| `lesson_chunks` | ~1.500 parÃ§a | `lesson_id`, `embedding (ivfflat)` |
| `user_answered_questions` | KullanÄ±cÄ± Ã— Soru | `user_id`, `next_review_at` |

### âš ï¸ Kritik Eksiklikler

#### 1.1 `question_bank` Tablosu Ä°ndeks EksikliÄŸi

```sql
-- SORUN: Åu sorgu yavaÅŸlayacak
SELECT * FROM question_bank qb
JOIN lesson_chunks lc ON lc.id = qb.chunk_id
JOIN lessons l ON l.id = lc.lesson_id
WHERE LOWER(l.name) = LOWER('Mikro Ä°ktisat')
```

> [!WARNING]
> `ILIKE` ve `LOWER()` sorgularÄ± indeks kullanamaz. 7.000+ satÄ±rda **full table scan** yapar.

**Ã‡Ã¶zÃ¼m Ã–nerisi:**
```sql
-- 1. Lesson name iÃ§in case-insensitive index
CREATE INDEX IF NOT EXISTS lessons_name_lower_idx 
ON lessons (LOWER(name));

-- 2. Question bank iÃ§in composite index
CREATE INDEX IF NOT EXISTS question_bank_chunk_created_idx
ON question_bank(chunk_id, created_at DESC);

-- 3. JSONB iÃ§indeki 'verified' alanÄ± iÃ§in partial index
CREATE INDEX IF NOT EXISTS question_bank_verified_idx
ON question_bank ((question_data->>'verified')) 
WHERE question_data->>'verified' = 'true';
```

#### 1.2 [fetchSmartMixQuestions](file:///Users/vedatdiyar/Desktop/exam-tracker-main/src/features/quiz/services/quizService.ts#99-194) Fonksiyonu VerimsizliÄŸi

[quizService.ts:147-152](file:///Users/vedatdiyar/Desktop/exam-tracker-main/src/features/quiz/services/quizService.ts#L147-L152) dosyasÄ±nda:

```typescript
// TÃ¼m cevaplanmÄ±ÅŸ soru ID'lerini Ã§ekiyor!
const { data: answeredData } = await supabase!
    .from('user_answered_questions')
    .select('question_id')
    .eq('user_id', userId);

const answeredIds = new Set((answeredData || []).map((a: any) => a.question_id));
```

> [!CAUTION]
> **Problem:** KullanÄ±cÄ± 5.000 soru cevapladÄ±ÄŸÄ±nda bu sorgu 5.000 UUID dÃ¶ndÃ¼rÃ¼r ve client-side filtreleme yapÄ±lÄ±r.

**Ã‡Ã¶zÃ¼m:** VeritabanÄ± seviyesinde RPC fonksiyonu:

```sql
CREATE OR REPLACE FUNCTION get_new_questions_for_user(
    p_user_id UUID,
    p_lesson_type TEXT,
    p_limit INT DEFAULT 10
)
RETURNS SETOF question_bank
LANGUAGE sql
STABLE
AS $$
    SELECT qb.*
    FROM question_bank qb
    INNER JOIN lesson_chunks lc ON lc.id = qb.chunk_id
    INNER JOIN lessons l ON l.id = lc.lesson_id
    WHERE LOWER(l.name) = LOWER(p_lesson_type)
      AND NOT EXISTS (
          SELECT 1 FROM user_answered_questions uaq
          WHERE uaq.question_id = qb.id AND uaq.user_id = p_user_id
      )
    ORDER BY random()
    LIMIT p_limit;
$$;
```

---

## 2. ğŸ§  SRS (SM-2) ALGORÄ°TMASI ANALÄ°ZÄ°

### Mevcut Parametreler

| Parametre | DeÄŸer | AÃ§Ä±klama |
|-----------|-------|----------|
| BaÅŸlangÄ±Ã§ Ease Factor | 2.5 | Standart SM-2 |
| Ä°lk DoÄŸru | 1 gÃ¼n | âœ… Uygun |
| Ä°kinci DoÄŸru | 6 gÃ¼n | âœ… Uygun |
| Sonraki DoÄŸrular | `interval Ã— ease` | Ãœstel bÃ¼yÃ¼me |
| YanlÄ±ÅŸ Ceza | EF -= 0.2 | Hafif ceza |
| Minimum EF | 1.3 | Standart |

### âš ï¸ Potansiyel Sorunlar

#### 2.1 "Yeni" vs "Bilinen" AyrÄ±mÄ± Yetersiz

```typescript
// srsEngine.ts:46-49
if (newRepetitionCount === 1) {
    newInterval = 1;  // Ä°lk doÄŸru: 1 gÃ¼n
} else if (newRepetitionCount === 2) {
    newInterval = 6;  // Ä°kinci doÄŸru: 6 gÃ¼n
}
```

> [!IMPORTANT]
> **Problem:** "Kolay bildiÄŸim soruyu ilk kez gÃ¶rÃ¼yorum" ile "Zor Ã¶ÄŸrendiÄŸim soruyu ilk kez doÄŸru yaptÄ±m" aynÄ± muameleyi gÃ¶rÃ¼yor.

**Ã‡Ã¶zÃ¼m: KullanÄ±cÄ±dan GÃ¼ven PuanÄ± Almak**

```typescript
// Ã–nerilen: 0-5 skalasÄ± (Anki tarzÄ±)
interface SRSInput {
    isCorrect: boolean;
    confidence?: 'again' | 'hard' | 'good' | 'easy'; // YENÄ°
    // ...
}

// easy â†’ interval Ã— 1.5 bonus
// hard â†’ interval Ã— 0.8 penalty
```

#### 2.2 450 Saatlik MÃ¼fredat iÃ§in Tempo Analizi

**Hedef:** 7.000+ soru, ~450 saat Ã§alÄ±ÅŸma

| Senaryo | GÃ¼nlÃ¼k Yeni Soru | GÃ¼nlÃ¼k Review | Toplam/GÃ¼n |
|---------|------------------|---------------|------------|
| YoÄŸun Mod | 50 yeni | ~100 review | ~150 soru |
| Normal Mod | 30 yeni | ~60 review | ~90 soru |
| Hafif Mod | 15 yeni | ~30 review | ~45 soru |

**Mevcut SM-2 AralÄ±klarÄ±:**
- 1 â†’ 6 â†’ 15 â†’ 38 â†’ 95 gÃ¼n...

> [!NOTE]
> Ãœstel bÃ¼yÃ¼me Ã§ok hÄ±zlÄ±. 5. tekrarda soru ~3 ay sonraya gidiyor. 450 saatlik yoÄŸun hazÄ±rlÄ±k iÃ§in **maksimum interval sÄ±nÄ±rÄ±** gerekli.

**Ã‡Ã¶zÃ¼m:**
```typescript
// srsEngine.ts'e ekle
const MAX_INTERVAL = 30; // SÄ±nav Ã¶ncesi son 1 ay iÃ§in
newInterval = Math.min(Math.round(currentInterval * currentEaseFactor), MAX_INTERVAL);
```

---

## 3. ğŸ›¡ï¸ HATA TOLERANSI VE RETRY MEKANÄ°ZMASI

### Mevcut Durum

#### 3.1 [quizService.ts](file:///Users/vedatdiyar/Desktop/exam-tracker-main/src/features/quiz/services/quizService.ts) - Retry MekanizmasÄ± âœ…

```typescript
// quizService.ts:396-465
const MAX_RETRIES = 3;

for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
    try {
        // ... API Ã§aÄŸrÄ±sÄ±
    } catch (error: any) {
        if (error?.status === 429) {
            const wait = 5000 * (attempt + 1); // Exponential backoff
            await new Promise(res => setTimeout(res, wait));
        }
    }
}
```

> [!TIP]
> âœ… [quizService.ts](file:///Users/vedatdiyar/Desktop/exam-tracker-main/src/features/quiz/services/quizService.ts) iÃ§inde 3 deneme ve rate limit handling mevcut.

#### 3.2 [stockpileService.ts](file:///Users/vedatdiyar/Desktop/exam-tracker-main/src/features/quiz/services/stockpileService.ts) - Retry MekanizmasÄ± âŒ

```typescript
// stockpileService.ts:84-100
try {
    const completion = await openai.chat.completions.create({...});
    return JSON.parse(completion.choices[0].message.content || "{}");
} catch (e) {
    console.error("Worker Generation Failed:", e);
    return null; // âŒ Sadece null dÃ¶nÃ¼yor, retry yok!
}
```

> [!CAUTION]
> **Problem:** Worker soru Ã¼retirken hata alÄ±rsa sistem sadece `null` dÃ¶nÃ¼yor. Retry mekanizmasÄ± yok!

**Ã‡Ã¶zÃ¼m:**
```typescript
async function generateCandidateQuestion(chunkContent: string, lessonType: string): Promise<QuizQuestionData | null> {
    const MAX_RETRIES = 3;
    
    for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
        try {
            await rateLimiter.waitForAvailability(2000);
            // ... mevcut kod
            return JSON.parse(completion.choices[0].message.content || "{}");
        } catch (e: any) {
            console.error(`Worker Generation Failed (Attempt ${attempt + 1}):`, e);
            
            if (e?.status === 429 && attempt < MAX_RETRIES - 1) {
                await new Promise(r => setTimeout(r, 5000 * (attempt + 1)));
                continue;
            }
            
            // JSON parse hatasÄ± - iÃ§erik temizleme dene
            if (e instanceof SyntaxError) {
                try {
                    const content = completion?.choices?.[0]?.message?.content || "";
                    const cleaned = content.replace(/```json/g, '').replace(/```/g, '').trim();
                    return JSON.parse(cleaned);
                } catch {
                    // Son deneme de baÅŸarÄ±sÄ±z
                }
            }
        }
    }
    return null;
}
```

#### 3.3 Validator Ã‡Ã¶kmesi Durumu

```typescript
// stockpileService.ts:148-151
} catch (e) {
    console.error("Validation Failed:", e);
    return { isValid: false, notes: "Validation Exception" };
}
```

> [!WARNING]
> Validator Ã§Ã¶kerse soru **reddediliyor** (`isValid: false`). Bu gÃ¼venli bir fallback ama potansiyel olarak geÃ§erli sorular kaybediliyor.

**Ä°yileÅŸtirme Ã–nerisi:**
- "DoÄŸrulanmamÄ±ÅŸ ama kayda deÄŸer" kategorisi eklenebilir
- Daha sonra batch validation iÃ§in kuyruÄŸa alÄ±nabilir

---

## 4. ğŸ“Š RECHARTS GRAFÄ°K VERÄ° TUTARLILIÄI

### Mevcut Validasyon

```typescript
// quizService.ts:445-450
if (parsedQuestion.chart_data) {
    const cd = parsedQuestion.chart_data;
    if (!cd.type || !cd.data || !Array.isArray(cd.data) || cd.data.length === 0) {
        parsedQuestion.chart_data = null;
    }
}
```

### âš ï¸ Eksik Kontroller

> [!WARNING]
> **Problem:** Veri yapÄ±sÄ± kontrol ediliyor ama deÄŸerler doÄŸrulanmÄ±yor.

```typescript
// Bu geÃ§er ama eksen uyumsuz olabilir:
{
    type: 'bar',
    data: [
        { label: 'A', value: 'yÃ¼z' },  // âŒ string value
        { label: 'B', value: -50 },     // âš ï¸ negatif deÄŸer
        { label: 'C', value: null }     // âŒ null value
    ]
}
```

**Ã‡Ã¶zÃ¼m:**
```typescript
function validateChartData(chartData: any): boolean {
    if (!chartData?.type || !chartData?.data || !Array.isArray(chartData.data)) {
        return false;
    }
    
    // Her veri noktasÄ±nÄ± kontrol et
    return chartData.data.every((item: any) => 
        typeof item.label === 'string' &&
        typeof item.value === 'number' &&
        !isNaN(item.value) &&
        item.value >= 0 // negatif deÄŸer izin verilmiyorsa
    );
}

// KullanÄ±m
if (parsedQuestion.chart_data && !validateChartData(parsedQuestion.chart_data)) {
    console.warn('Chart data invalid, nullifying:', parsedQuestion.chart_data);
    parsedQuestion.chart_data = null;
}
```

### QuizChart.jsx Savunma MekanizmasÄ±

```jsx
// QuizChart.jsx:23-24
export function QuizChart({ chartData, className = '' }) {
    if (!chartData || !chartData.data) return null;
    // âœ… Temel kontrol var
```

> [!TIP]
> Render seviyesinde de try-catch eklenebilir.

---

## 5. ğŸ–¼ï¸ GÃ–RSEL Ä°ÅLEME ANALÄ°ZÄ°

### Mevcut AkÄ±ÅŸ

```mermaid
sequenceDiagram
    participant MD as Markdown Notu
    participant QS as quizService.ts
    participant AI as Groq/Llama
    participant UI as QuizModal
    
    MD->>QS: extractImagesFromMarkdown()
    QS->>QS: GÃ¶rsel path'lerini Ã§Ä±kar
    QS->>AI: Metin + GÃ¶rsel META verisi
    Note over AI: GÃ¶rsel iÃ§eriÄŸi GÃ–RMÄ°YOR<br/>Sadece path ve alt-text
    AI->>QS: JSON response (related_image: "[GÃ–RSEL 1]")
    QS->>QS: related_image â†’ gerÃ§ek path mapping
    QS->>UI: question_data
    UI->>UI: <img src="/content/{path}" />
```

### âš ï¸ Kritik Bulgu: GÃ¶rseller AI'ya GÄ°TMÄ°YOR

```typescript
// quizService.ts:337-352
const images = extractImagesFromMarkdown(sectionContent);
// ...
imageContexts.push(`[GÃ–RSEL ${index + 1} MEVCUT]: Bu noktada "${fullPath}" dosya yollu bir gÃ¶rsel/grafik var. AÃ§Ä±klamasÄ±/Etiketi: "${img.placeholder}".`);
```

> [!IMPORTANT]
> **SonuÃ§:** AI modeli (Llama) gÃ¶rselin **iÃ§eriÄŸini** gÃ¶rmÃ¼yor. Sadece:
> - Dosya yolu
> - Alt-text (varsa)
> 
> Bu, gÃ¶rsel tabanlÄ± sorular iÃ§in **ciddi bir kÄ±sÄ±tlama**.

### Ã‡Ã¶zÃ¼m Alternatifleri

| SeÃ§enek | Avantaj | Dezavantaj |
|---------|---------|------------|
| 1. GPT-4 Vision | GÃ¶rsel anlama | Maliyet yÃ¼ksek |
| 2. GÃ¶rsel â†’ Metin OCR | Mevcut modelle Ã§alÄ±ÅŸÄ±r | KarmaÅŸÄ±k gÃ¶rsellerde yetersiz |
| 3. Manuel annotasyon | En doÄŸru | Zaman yoÄŸun |
| 4. GeliÅŸmiÅŸ alt-text | DÃ¼ÅŸÃ¼k maliyet | KÄ±sÄ±tlÄ± bilgi |

**Ã–nerilen Hibrit YaklaÅŸÄ±m:**

1. Markdown notlarÄ±nda gÃ¶rsellere **detaylÄ± alt-text** ekle:
```markdown
![Talep EÄŸrisi - X ekseninde miktar (0-100), Y ekseninde fiyat (0-50 TL), aÅŸaÄŸÄ± eÄŸimli, elastik bÃ¶lge iÅŸaretli](media/talep_egrisi.png)
```

2. [extractImagesFromMarkdown](file:///Users/vedatdiyar/Desktop/exam-tracker-main/src/features/quiz/services/quizUtils.ts#13-27) fonksiyonunu geliÅŸtir:
```typescript
export function extractImagesFromMarkdown(content: string): { 
    placeholder: string; 
    relativePath: string;
    altText: string;  // YENÄ°
    description?: string;  // YENÄ°: AyrÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ aÃ§Ä±klama
}[] {
    // ... parse logic
}
```

---

## 6. ğŸ“ˆ Ä°STATÄ°STÄ°K SÄ°STEMÄ° ANALÄ°ZÄ°

### Alt Ders BazlÄ± Stok Doluluk Takibi

```typescript
// stockpileConfig.ts
export const STOCKPILE_CONFIG: Record<string, number> = {
    'Mikro Ä°ktisat': 1000,
    'Makro Ä°ktisat': 900,
    // ...
};
```

### Eksik: GerÃ§ek ZamanlÄ± Doluluk Sorgusu

> [!NOTE]
> Stok hedefleri tanÄ±mlÄ± ama mevcut doluluk oranÄ±nÄ± sorgulayan bir mekanizma yok.

**Ã‡Ã¶zÃ¼m:**
```sql
CREATE OR REPLACE FUNCTION get_stockpile_status()
RETURNS TABLE (
    lesson_name TEXT,
    target_count INT,
    current_count BIGINT,
    fill_percentage FLOAT,
    verified_count BIGINT
)
LANGUAGE sql
STABLE
AS $$
    SELECT 
        l.name AS lesson_name,
        COALESCE(sc.target, 100) AS target_count,
        COUNT(qb.id) AS current_count,
        (COUNT(qb.id)::FLOAT / COALESCE(sc.target, 100)) * 100 AS fill_percentage,
        COUNT(qb.id) FILTER (WHERE qb.question_data->>'verified' = 'true') AS verified_count
    FROM lessons l
    LEFT JOIN lesson_chunks lc ON lc.lesson_id = l.id
    LEFT JOIN question_bank qb ON qb.chunk_id = lc.id
    LEFT JOIN stockpile_config sc ON sc.lesson_name = l.name  -- Bu tablo eklenmeli
    GROUP BY l.name, sc.target
    ORDER BY fill_percentage ASC;
$$;
```

### SRS BaÅŸarÄ± Takibi

Mevcut migration'da [user_answered_questions](file:///Users/vedatdiyar/Desktop/exam-tracker-main/supabase/migrations/010_add_srs_fields.sql) ile SRS verileri takip ediliyor:
- `ease_factor`
- `interval`
- `repetition_count`
- `next_review_at`

> [!TIP]
> âœ… SRS tracking mevcut ve iyi yapÄ±landÄ±rÄ±lmÄ±ÅŸ.

---

## ğŸ“‹ Ã–NCELÄ°KLÄ° AKSIYON Ã–ÄELERÄ°

### ğŸ”´ Kritik (Hemen YapÄ±lmalÄ±)

1. **Stockpile Retry MekanizmasÄ±**
   - [stockpileService.ts](file:///Users/vedatdiyar/Desktop/exam-tracker-main/src/features/quiz/services/stockpileService.ts) dosyasÄ±na retry logic ekle
   - Tahmini sÃ¼re: 1 saat

2. **Chart Data Validasyonu**
   - [quizService.ts](file:///Users/vedatdiyar/Desktop/exam-tracker-main/src/features/quiz/services/quizService.ts) iÃ§inde `validateChartData()` fonksiyonu ekle
   - Tahmini sÃ¼re: 30 dakika

### ğŸŸ¡ Ã–nemli (Bu Hafta)

3. **SRS Max Interval SÄ±nÄ±rÄ±**
   - [srsEngine.ts](file:///Users/vedatdiyar/Desktop/exam-tracker-main/src/features/quiz/logic/srsEngine.ts) dosyasÄ±na `MAX_INTERVAL = 30` ekle
   - Tahmini sÃ¼re: 15 dakika

4. **VeritabanÄ± Ä°ndeksleri**
   - Yeni migration dosyasÄ± oluÅŸtur: `011_performance_indexes.sql`
   - Tahmini sÃ¼re: 1 saat

### ğŸŸ¢ Ä°yileÅŸtirme (Bu Ay)

5. **"Yeni Soru" RPC Fonksiyonu**
   - Client-side filtrelemeyi DB seviyesine taÅŸÄ±
   - Tahmini sÃ¼re: 2 saat

6. **GÃ¶rsel Alt-Text ZenginleÅŸtirme**
   - Mevcut markdown notlarÄ±nÄ± gÃ¶zden geÃ§ir
   - DetaylÄ± aÃ§Ä±klamalar ekle
   - Tahmini sÃ¼re: Devam eden iÅŸ

---

## ğŸ“Š Ã–zet Tablo

| Kategori | Durum | Skor |
|----------|-------|------|
| VeritabanÄ± Ä°ndeksleme | âš ï¸ KÄ±smi | 6/10 |
| SRS AlgoritmasÄ± | âœ… Ä°yi | 8/10 |
| Retry MekanizmasÄ± | âš ï¸ Eksik | 5/10 |
| Chart Validasyonu | âš ï¸ Yetersiz | 6/10 |
| GÃ¶rsel Ä°ÅŸleme | âš ï¸ SÄ±nÄ±rlÄ± | 5/10 |
| Ä°statistik Takibi | âœ… Ä°yi | 8/10 |

**Genel Skor: 6.3/10** - Fonksiyonel ama Ã¶lÃ§eklenme Ã¶ncesi iyileÅŸtirme gerekli.

